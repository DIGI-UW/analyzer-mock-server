{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://openelis-global.org/astm-mock-server/template-schema",
  "title": "Analyzer Message Template",
  "description": "Schema for analyzer message templates (M4 multi-protocol simulator). Supports ASTM, HL7, RS232, FILE protocols with field definitions and deterministic seed values.",
  "type": "object",
  "required": ["analyzer", "protocol", "fields"],
  "properties": {
    "analyzer": {
      "type": "object",
      "description": "Analyzer identification metadata",
      "required": ["name", "model", "manufacturer"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Full analyzer name as registered in OpenELIS"
        },
        "model": {
          "type": "string",
          "description": "Analyzer model number"
        },
        "manufacturer": {
          "type": "string",
          "description": "Analyzer manufacturer"
        },
        "category": {
          "type": "string",
          "enum": ["HEMATOLOGY", "CHEMISTRY", "IMMUNOLOGY", "MICROBIOLOGY", "MOLECULAR", "COAGULATION"],
          "description": "Analyzer category for classification"
        }
      }
    },
    "protocol": {
      "type": "object",
      "description": "Communication protocol configuration",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["ASTM", "HL7", "RS232", "FILE"],
          "description": "Protocol type"
        },
        "version": {
          "type": "string",
          "description": "Protocol version (e.g., 'LIS2-A2' for ASTM)"
        },
        "transport": {
          "type": "string",
          "enum": ["TCP", "HTTP", "SERIAL", "FILE"],
          "description": "Transport mechanism"
        }
      }
    },
    "identification": {
      "type": "object",
      "description": "How OpenELIS identifies this analyzer (ASTM header, HL7 sender, IP, file pattern)",
      "properties": {
        "astm_header": {
          "type": "string",
          "description": "ASTM H-segment sender identification (field 5)"
        },
        "msh_sender": {
          "type": "string",
          "description": "HL7 MSH-3 field (legacy, use hl7_sending_app)"
        },
        "hl7_sending_app": {
          "type": "string",
          "description": "HL7 MSH-3 sending application"
        },
        "hl7_sending_facility": {
          "type": "string",
          "description": "HL7 MSH-4 sending facility"
        },
        "ip_pattern": {
          "type": "string",
          "description": "IP address/range"
        },
        "file_pattern": {
          "type": "string",
          "description": "Glob pattern for files"
        }
      }
    },
    "fileFormat": {
      "type": "object",
      "description": "File format configuration for FILE protocol",
      "properties": {
        "delimiter": {
          "type": "string",
          "default": ",",
          "description": "Field delimiter character (e.g., ',', ';', '\\t')"
        },
        "hasHeader": {
          "type": "boolean",
          "default": true,
          "description": "Whether the first line contains column headers"
        },
        "encoding": {
          "type": "string",
          "default": "UTF-8",
          "description": "Character encoding (e.g., 'UTF-8', 'ISO-8859-1')"
        },
        "extension": {
          "type": "string",
          "default": ".csv",
          "description": "File extension (e.g., '.csv', '.txt')"
        }
      }
    },
    "columns": {
      "type": "array",
      "description": "Column definitions for FILE protocol",
      "items": {
        "type": "object",
        "required": ["index", "name"],
        "properties": {
          "index": {
            "type": "integer",
            "minimum": 0,
            "description": "Zero-based column index"
          },
          "name": {
            "type": "string",
            "description": "Column name/header"
          },
          "description": {
            "type": "string",
            "description": "Human-readable description of the column"
          }
        }
      }
    },
    "fields": {
      "type": "array",
      "description": "Test/result field definitions",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["code", "name", "type"],
        "properties": {
          "code": {
            "type": "string",
            "description": "Analyzer test code (e.g., 'WBC', 'HGB')"
          },
          "name": {
            "type": "string",
            "description": "Full test name"
          },
          "loinc": {
            "type": "string",
            "description": "LOINC code (optional for tests without standard LOINC)"
          },
          "type": {
            "type": "string",
            "enum": ["NUMERIC", "QUALITATIVE", "TEXT"],
            "default": "NUMERIC",
            "description": "Result type for value generation"
          },
          "unit": {
            "type": ["string", "null"],
            "description": "Unit of measure (e.g., '10^3/uL', 'g/dL')"
          },
          "normalRange": {
            "type": "string",
            "description": "Normal reference range (e.g., '4.0-10.0')"
          },
          "seedValue": {
            "type": ["number", "null"],
            "description": "Deterministic value for reproducible testing"
          },
          "seedQualitative": {
            "type": "string",
            "description": "Deterministic qualitative value for reproducible testing (e.g., 'NEGATIVE')"
          },
          "possibleValues": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Allowed values for QUALITATIVE type (e.g., NEGATIVE, POSITIVE)"
          },
          "version": {
            "type": "string",
            "description": "Assay version (e.g., '2.1') â€” used in ASTM R.3 component 6"
          },
          "complementaryResults": {
            "type": "array",
            "description": "Sub-results for multi-level ASTM results (e.g., Ct, Conc/LOG for GeneXpert)",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Complementary result name (e.g., 'Conc/LOG', 'Ct', 'EndPt')"
                },
                "unit": {
                  "type": "string",
                  "description": "Unit for the complementary result"
                },
                "seedValue": {
                  "type": "number",
                  "description": "Deterministic value for this complementary result"
                }
              }
            }
          }
        }
      }
    },
    "astm_config": {
      "type": "object",
      "description": "ASTM-specific message configuration overrides (for analyzers needing non-default ASTM fields)",
      "properties": {
        "processing_id": {
          "type": "string",
          "default": "P",
          "description": "H.12 Processing ID (P=Production, D=Debugging, T=Training)"
        },
        "version_number": {
          "type": "string",
          "description": "H.13 Version Number (e.g., '1394-97' for GeneXpert, 'LIS2-A2' for others)"
        },
        "receiver_id": {
          "type": "string",
          "description": "H.10 Receiver ID (e.g., 'LIS')"
        },
        "specimen_descriptor": {
          "type": "string",
          "description": "O.16 Specimen Descriptor (e.g., 'ORH' for POCT1-A Other)"
        },
        "enable_isid": {
          "type": "boolean",
          "default": false,
          "description": "Generate Instrument Specimen ID in O.4"
        },
        "enable_qc": {
          "type": "boolean",
          "default": false,
          "description": "Generate QC sample messages in addition to patient messages"
        }
      }
    },
    "qcSample": {
      "type": "object",
      "description": "QC sample configuration for generating QC messages (requires astm_config.enable_qc=true)",
      "properties": {
        "id": {
          "type": "string",
          "description": "QC specimen ID (e.g., 'QC-MTB-CTRL-001')"
        },
        "actionCode": {
          "type": "string",
          "default": "Q",
          "description": "O.12 Action Code that marks this as a QC sample"
        },
        "fields": {
          "type": "array",
          "description": "QC-specific field overrides (code + seedQualitative/seedValue)",
          "items": {
            "type": "object",
            "properties": {
              "code": { "type": "string", "description": "Field code to override" },
              "seedQualitative": { "type": "string", "description": "Fixed qualitative result for QC" },
              "seedValue": { "type": "number", "description": "Fixed numeric result for QC" }
            }
          }
        }
      }
    },
    "serial_config": {
      "type": "object",
      "description": "RS232 configuration (if protocol.transport=SERIAL)",
      "properties": {
        "baud_rate": { "type": "integer", "default": 9600 },
        "data_bits": { "type": "integer", "default": 8 },
        "parity": { "enum": ["NONE", "EVEN", "ODD"], "default": "NONE" },
        "stop_bits": { "type": "number", "default": 1 }
      }
    },
    "file_config": {
      "type": "object",
      "description": "File format configuration (if protocol.transport=FILE)",
      "properties": {
        "format": { "enum": ["CSV", "TSV", "TXT", "XLS"] },
        "delimiter": { "type": "string", "default": "," },
        "has_header": { "type": "boolean", "default": true },
        "column_mapping": { "type": "object" }
      }
    },
    "testPatient": {
      "type": "object",
      "description": "Test patient demographics for deterministic mode",
      "properties": {
        "id": {
          "type": "string",
          "description": "Patient ID"
        },
        "name": {
          "type": "string",
          "description": "Patient name in ASTM format (Last^First^Middle)"
        },
        "sex": {
          "type": "string",
          "enum": ["M", "F", "U"],
          "description": "Patient sex"
        },
        "dob": {
          "type": "string",
          "pattern": "^[0-9]{8}$",
          "description": "Date of birth (YYYYMMDD)"
        }
      }
    },
    "testSample": {
      "type": "object",
      "description": "Test sample defaults for deterministic mode",
      "properties": {
        "id": {
          "type": "string",
          "description": "Sample/Accession ID"
        },
        "type": {
          "type": "string",
          "description": "Sample type (e.g., 'CBC^Complete Blood Count')"
        }
      }
    },
    "testSamples": {
      "type": "array",
      "description": "Array of test sample data for FILE protocol (for generating sample files)",
      "items": {
        "type": "object",
        "properties": {
          "sampleId": {
            "type": "string",
            "description": "Sample/Accession ID"
          },
          "position": {
            "type": "string",
            "description": "Well position (e.g., 'A01')"
          },
          "result": {
            "type": "string",
            "description": "Test result value"
          },
          "interpretation": {
            "type": "string",
            "description": "Result interpretation"
          }
        }
      }
    }
  }
}
